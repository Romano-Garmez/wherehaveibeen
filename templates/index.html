{% extends "layout.html" %}

{%block title %}
<title>OwnTracks Map</title>
{%endblock%}

{% block main %}


<!-- Get OwnTracks server info so we can read data from it -->
<div>
    <div class="form-popup" id="myForm">
        <form action="/setcookie" method="POST">

            <h3>Enter OwnTrack Login and URL</h3>

            <input type='text' placeholder='username' name='username' />
            <input type='password' placeholder='password' name='password' />
            <input type='serverurl' placeholder='https://[your domain]' name='serverurl' /></p>
            <input class="btn" type='submit' value='Login' />
        </form>
    </div>

    <div id="map"></div>
</div>
<script>
    // todo: use these to handle move entries
    var qualityInverse = 3;
    var circleSize = 0.5;


    var control;
    // Initialize the map
    var map = L.map('map').setView([37.7749, -122.4194], 13);

    // Add a tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    async function getUsersAndDevices() {
        return fetch('/usersdevices')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error fetching users and devices. Are you logged in?`);
                }
                return response.json();  // Parse the JSON from the response
            })
            .then(data => {


                // Iterate through the data and populate the sets
                var select = document.getElementById("userBox");
                select.innerHTML = '';

                select = document.getElementById("deviceBox");
                select.innerHTML = '';

                var el;

                data.forEach(entry => {
                    if (entry.username) {
                        select = document.getElementById("userBox");

                        el = document.createElement("option");
                        el.textContent = entry.username;
                        el.value = entry.username;
                        select.appendChild(el);
                    }
                    if (entry.device) {
                        select = document.getElementById("deviceBox");

                        el = document.createElement("option");
                        el.textContent = entry.device;
                        el.value = entry.device;
                        select.appendChild(el);
                    }
                });

            })
            .catch(error => {
                console.error('Fetch users and devices error:', error);
                return { users: [], devices: [] };
            });

    }


    //handles all data retrieval and drawing on points/routes on map
    function fetchLocations() {
        fetch('/locations?' + new URLSearchParams({
            startdate: document.getElementById('startBox').value,
            enddate: document.getElementById('endBox').value,
            user: document.getElementById('userBox').value,
            device: document.getElementById('deviceBox').value
        }).toString())
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error fetching location data+Are you logged in?');
                }
                return response.json();
            })
            .then(data => {
                // Successfully retrieved data, hide login prompt
                closeForm();

                if (data.features && Array.isArray(data.features)) {
                    // Create an array to hold the coordinates
                    var latlngs = [];

                    data.features.forEach(feature => {
                        if (feature.geometry && feature.geometry.coordinates) {
                            const [lng, lat] = feature.geometry.coordinates;
                            // Add coordinates to the array
                            latlngs.push([lat, lng]);
                            // Add marker to the map
                            //L.marker([lat, lng]).addTo(map)
                            //.bindPopup(`<b>${feature.properties.name}</b><br>Velocity: ${feature.properties.vel} km/h`);
                        }
                    });

                    // Get selected buffering method
                    var bufferingMethod = document.getElementById('bufferMethod').value;

                    if (latlngs.length > 1) {
                        if (bufferingMethod === 'complexRoute') {
                            bufferComplexRoute(latlngs);
                        } else if (bufferingMethod === 'simpleRoute') {
                            bufferSimpleRoute(latlngs);
                        }
                    }
                } else {
                    console.error('Unexpected data format:', data);
                }
            })
            .catch(error => {
                console.error('Fetch location error:', error);
            });
    }

    function bufferComplexRoute(latlngs) {
        drawRoute(latlngs);
        control.hide(); // hide top right panel

        // Listen for the routesfound event
        control.on('routesfound', function (e) {
            var routes = e.routes;

            // Create a lineString for buffering based on the actual route
            var routeCoords = routes[0].coordinates.map(coord => [coord.lng, coord.lat]);
            var lineString = turf.lineString(routeCoords);

            var bufferLayer = drawBuffer(lineString)

            // Adjust the view to show the entire buffered area
            var bounds = bufferLayer.getBounds();
            map.fitBounds(bounds);
        });

    }

    function bufferSimpleRoute(latlngs) {

        // Create a lineString for buffering
        var lineString = turf.lineString(latlngs.map(latlng => [latlng[1], latlng[0]])); // [lng, lat]

        drawBuffer(lineString)

        // Adjust the view to show all markers, circles, and the polyline
        var bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds);
    }


    function drawRoute(latlngs) {
        control = L.routing.control({
            waypoints: latlngs
                .filter((_, index) => index % qualityInverse === 0) // Filter to include only every other entry
                .map(latlng => L.latLng(latlng[0], latlng[1])),
            router: L.Routing.osrmv1({ serviceUrl: '/proxy' }),
            routeWhileDragging: true,
            createMarker: function () { return null; }, // Disable default marker
        }).addTo(map);
    }

    function drawBuffer(lineString) {

        // Simplify the route before buffering
        var simplifiedLineString = turf.simplify(lineString, { tolerance: .001, highQuality: false });

        // Buffer the route with Turf.js
        var buffered = turf.buffer(simplifiedLineString, circleSize, { units: 'kilometers' }); // 1 km buffer


        getCoverageStats(buffered, simplifiedLineString);


        // Convert the buffer to GeoJSON and add it to the map
        var bufferLayer = L.geoJSON(buffered, {
            style: function () {
                return { color: 'rgba(0, 0, 255, 0.4)', weight: 2 };
            }
        }).addTo(map);

        return bufferLayer;
    }

    function getCoverageStats(buffered, lineString) {
        // Convert distance to kilometers
        var distanceKm = turf.length(lineString, { units: 'kilometers' }); // Total distance in kilometers

        document.getElementById('totalDist').innerHTML = "<p>" + Math.round(distanceKm * 100) / 100 + "km or " + Math.round((distanceKm / 1.609) * 100) / 100 + "mi</p>";

        // Calculate the total area of the route
        var area = turf.area(buffered) / 1e6; // Convert m² to km²

        document.getElementById('totalArea').innerHTML = "<p>" + Math.round(area * 100) / 100 + "km² or " + Math.round((area / 1.609) * 100) / 100 + "mi²</p>";

        document.getElementById('totalAreaPct').innerHTML = "<p>" + area / 863440 + "%" + "</p>";
    }



</script>

<div id="infoBox">
    <div id="leftPanel">
        <!-- MAP INFO -->
        <h1 id="title">Information </h1>
        <p> This map shows the location of the devices that are sending their location data to the Owntracks server.
        </p>

        <h4>Total distance driven </h4>
        <div id="totalDist"></div>

        <h4>Area explored is </h4>
        <div id="totalArea"></div>

        <h4>Percentage of west coast covered </h4>
        <div id="totalAreaPct"></div>
    </div>
    <div id="rightPanel">
        <!-- MAP CONTROLS -->
        <h1> Filters and Settings </h1>
        <h4>Choose a user and device</h4>

        <select id="userBox">
            <option value="" selected disabled>Choose a user</option>
        </select>
        <select id="deviceBox">
            <option value="" selected disabled>Choose a device</option>
        </select>
        <input type="submit" onsubmit="filterMap()" style="display: none" />
        <br>

        <h4>Choose a route computation method</h4>
        <select id="bufferMethod">
            <option value="complexRoute">Complex Route Buffer</option>
            <option value="simpleRoute">Simple Route Buffer</option>
        </select>

        <br>

        <h4>Map settings</h4>
        <input type="button" value="Remove Route" onclick="eraseRoute()" />

        <br>

        <h4>Time frame</h4>
        <div style="float:left; width: 50%;">
            <h5>Start Date </h5>

            <input type="date" id="startBox" onkeyup="" name="trip-start" value="2015-01-01" min="2015-01-01"
                max="2099-12-31" />
        </div>
        <div style="float:left; width: 50%;">
            <h5>End Date </h5>
            <input type="date" id="endBox" onkeyup="" name="trip-start" value="2099-12-31" min="2015-01-01"
                max="2099-12-31" />
        </div>
        <br>

        <h4>Save settings</h4>
        <input type="button" value="Save and Apply" onclick="filterMap()" />
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    function filterMap() {
        console.log("Filtering map");

        try {
            eraseRoute();
            eraseLayers();
        }
        catch (err) {
            console.log("No map data to erase");
        }


        //Remake route
        // Add a tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        fetchLocations();
    }

    function eraseRoute() {
        map.removeControl(control);
    }

    function eraseLayers() {
        map.eachLayer((layer) => {
            layer.remove();
        });
    }

</script>

<script>

    function openForm() {
        document.getElementById("myForm").style.display = "block";
        document.getElementById("sign_out").style.display = "none"
    }
    function closeForm() {
        document.getElementById("myForm").style.display = "none";
        document.getElementById("sign_out").style.display = "block";
    }


    //find users and devices, then calculate route for the first entry
    getUsersAndDevices().then(usersAndDevices => {
        fetchLocations();
    });


</script>

{% endblock %}